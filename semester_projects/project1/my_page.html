import cgi
import my_parsers
import urllib.request
import json
import re

HTML_PAGE ="""
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>EasyShop.com</title>
</head>
<body>
<form method=POST action="">
    <h1 style="text-align: center">Enter name of item to find</h1>

    <p style="text-align: center">
        <input size=50 type=text name=to_search value=""><br>

    <table align="center" style="text-align: center">
    <tr>
        <td>Type sort: </td>
        <td>
            <select name="type_sort">
                <option value="relevant">Relevant</option>
                <option value="cheap">Price low to high</option>
                <option value="fresh">What's new</option>
            </select>
        </td>
        <td>Gender: </td>
        <td>
            <select name="gender">
                <option value="any">any</option>
                <option value="man">man</option>
                <option value="woman">woman</option>
            </select>
        </td>

        <td>Size: </td>
        <td>
        {}
        </td>

        <td>Number of pages: </td>
        <td>
            <select name="num">
                <option value="3">3</option>
                <option value="5">5</option>
                <option value="7">7</option>
            </select>
        </td>
    </tr>
    </table>

    <table align="center" style="text-align: center">
        <tr>
        <td>Choose shops: </td>
        <td>
            <input type="checkbox" name="shops" value="Asos" checked>Asos.com
            <input type="checkbox" name="shops" value="Amazon" checked>Amazon.com
            <input type="checkbox" name="shops" value="Rozetka" checked>Rozetka.com
        </td>
        </tr>
    </table>

    <br>

    <table align="center" style="text-align: center">
        <tr>
        <td>you wanna to search this item periodically?</td>
        <td>
            <select name="repeat">
                <option value="yes">yes</option><br>
                <option value="no">no</option><br>
        </td>

        <td>  if yes:  </td>
        <td>
            <select name="repeat_requests">
                <option value="hour">one per hour</option>
                <option value="day">one per day</option>
                <option value="week">one per week</option>
            </select>
        </td>

        <td>
            <text> hours: </text>
            {}
            <text> minutes: </text>
            {}
        </td>
    <tr>
    </table>
    <p style="text-align: center">
        <input type="submit" value="Search">

    <table>
        <tr>
        <td>
            <b><pre>Ціна                Посилання на товар</pre></b>
            <b><pre>Ціна зі знижкою     Опис</pre></b>
        </td>
    </table>
    
    {}
</form>
</body>
</html>
"""

item_tables = """
<table>
    <tr>
    <td>
        <pre>{}               <a href="{}">{}</a></pre><br />
        <pre>{}               {}</pre>
    </td>
</table>
"""

def convert(val_str, to_valuta="UAH"):

    with open("currency.json") as file:
        inf = json.load(file)

    val_arr = val_str.split("-")

    if len(val_arr) > 1:

        if val_arr[0].startswith("$"):
            req = "USD_"+to_valuta
            coef = inf[-1][req]
            return str(round(coef * float(val_arr[0].strip()[1:]))) + " - " + str(round(coef * float(val_arr[-1].strip()[1:])))

    else:
        if val_str.startswith("£"):
            req = "GBP_" + to_valuta
            coef = inf[-1][req]
            return str(round(coef * float(val_str[1:])))

        else:
            return val_str.strip()


class Server:
    def __init__(self):

        self.list_sizes = [str(i) for i in range(35, 49)] + ["XXS", "XS", "S", "M", "L", "XL", "XXL"]


    def make_listbox(self, name, values):

        select_block = '<select name="{0}">\n{1}</select>\n'

        option_block = '<option value="{0}">{0}</option>\n'

        return select_block.format(name, ''.join(option_block.format(v) for v in values))


    def combine_shops(self, shops, request, type_sort, gender, size, num):
        all_info = []

        for shop in shops:

            if shop == "Asos.com":
                all_info.append(my_parsers.Asos(request, type_sort, gender, size, num))

            elif shop == "Amazon.com":
                all_info.append(my_parsers.Amazon(request, type_sort, gender, size, num))

            elif shop == "Rozetka.com":
                all_info.append(my_parsers.Rozetka(request, type_sort, gender, size, num))

        return all_info

    def info_to_form(self, dict_info):
        full_info = ""

        for shop in dict_info:

            descr = ""
            price = ""

            sale_price = ""

            for link, information in shop.items():
                href = link
                site = re.findall('https?://(?:[-\w.]|(?:%[\da-fA-F]{2}))+', link)[0]
                site = str(site).replace("https://", "")
                descr = ""
                full_info += '<h1 style="text-align: center">{}</h1>'.format(site)
                for name, value in information.items():

                    if name == "price":
                        price = convert(value)


                    elif name == "sale price":
                        sale_price = convert(value)


                    elif name == "size":
                        sizes = "Також доступні опції(розмри): " + ", ".join(value) + "<br>\n"

                    elif name == "description":
                        descr = sizes + "Про товар: " + value

                    else:
                        descr += sizes + name + " : " + value + "<br>\n"

                full_info += item_tables.format(price, href, site, sale_price, descr)
            full_info += "<br>\n"
        return full_info


    def application(self, environ, start_response):
        request = None
        type_sort = None
        gender = None
        size = None
        num = None
        shops = None
        repeat = 'no'
        repeat_requests = "week"
        hours = None
        minutes = None


        if environ.get('PATH_INFO', '').lstrip('/') == '':

            form = cgi.FieldStorage(fp=environ['wsgi.input'], environ=environ)
            result = ""
            if 'to_search' in form:

                request = form['to_search'].value
                type_sort = form.getvalue("type_sort")
                gender = form.getvalue("gender")
                size = form.getvalue("size")
                num = form.getvalue("num")
                shops = form.getvalue("shops") #array

                repeat = form.getvalue("repeat")
                repeat_requests = form.getvalue("repeat_requests")
                hours = form.getvalue("hours")
                minutes = form.getvalue("minutes")


                dict_info = self.combine_shops(shops, request, type_sort, gender, size, num)
                result = self.info_to_form(dict_info)


            body = HTML_PAGE.format(self.make_listbox("size", self.list_sizes),
                                    self.make_listbox("hours", [i for i in range(0,24)]),
                                    self.make_listbox("minutes", [i for i in range(0,60)]), result)

            start_response('200 OK', [('Content-Type', 'text/html; charset=utf-8')])
        else:

            start_response('404 NOT FOUND', [('Content-Type', 'text/plain')])
            body = 'Сторінку не знайдено'

        return [bytes(body, encoding='utf-8')]


    def start_server(self):
        from wsgiref.simple_server import make_server
        print('=== Local WSGI webserver ===')
        httpd = make_server('localhost', 8051, self.application)
        httpd.serve_forever()


if __name__ == '__main__':
    s = Server()
    s.start_server()

    #print(my_parsers.Asos("adidas yung 1", "cheap", "44", "man"))

